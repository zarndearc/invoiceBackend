<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers & Invoices</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .form-section {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container mt-5">
    <h1 class="mb-4 text-center">Customer & Invoice Management</h1>
    
    <!-- Search and Add Buttons -->
    <div class="d-flex justify-content-between mb-3">
      <input type="text" id="searchInput" class="form-control w-50" placeholder="Search by Name or Invoice No">
      <div>
        <button id="showCustomerForm" class="btn btn-primary me-2">Add Customer</button>
        <button id="showInvoiceForm" class="btn btn-secondary">Add Invoice</button>
      </div>
    </div>

    <!-- Customer Table -->
    <h2 class="mt-4">Customers</h2>
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Address</th>
          <th>State Code</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="customerTableBody">
        <!-- Rows will be populated by JavaScript -->
      </tbody>
    </table>

    <!-- Invoice Table -->
    <h2 class="mt-4">Invoices</h2>
    <table class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Invoice No</th>
          <th>GSTIN</th>
          <th>Tax Rate</th>
          <th>Total Value</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoiceTableBody">
        <!-- Rows will be populated by JavaScript -->
      </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination will be populated by JavaScript -->
      </ul>
    </nav>

    <!-- Add Customer Form -->
    <div id="customerFormSection" class="form-section">
      <h3 class="mt-4">Add Customer</h3>
      <form id="customerForm" class="mt-3">
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input type="text" id="name" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">Address</label>
          <input type="text" id="address" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="stateCode" class="form-label">State Code</label>
          <input type="text" id="stateCode" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Add Customer</button>
      </form>
    </div>

    <!-- Add Invoice Form -->
    <div id="invoiceFormSection" class="form-section">
      <h3 class="mt-4">Add Invoice</h3>
      <form id="invoiceForm" class="mt-3">
        <div class="mb-3">
          <label for="invoiceNo" class="form-label">Invoice No</label>
          <input type="text" id="invoiceNo" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="gstin" class="form-label">GSTIN</label>
          <input type="text" id="gstin" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="taxRate" class="form-label">Tax Rate (%)</label>
          <input type="number" id="taxRate" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="taxableValue" class="form-label">Taxable Value</label>
          <input type="number" id="taxableValue" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="cgst" class="form-label">CGST</label>
          <input type="number" id="cgst" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="sgst" class="form-label">SGST</label>
          <input type="number" id="sgst" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="igst" class="form-label">IGST</label>
          <input type="number" id="igst" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="totalValue" class="form-label">Total Value</label>
          <input type="number" id="totalValue" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Add Invoice</button>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const apiUrl = "http://localhost:3000"; // Base URL of your API
  
    // Show/hide form sections
    document.getElementById('showCustomerForm').onclick = () => {
      document.getElementById('customerFormSection').style.display = 'block';
      document.getElementById('invoiceFormSection').style.display = 'none';
    };
  
    document.getElementById('showInvoiceForm').onclick = () => {
      document.getElementById('invoiceFormSection').style.display = 'block';
      document.getElementById('customerFormSection').style.display = 'none';
    };
  
    // Variables to store pagination info
    let currentCustomerPage = 1;
    let currentInvoicePage = 1;
    const resultsPerPage = 5;
  
    // Fetch and render customer data
    async function fetchCustomers(page = 1, searchTerm = '') {
      const response = await fetch(`${apiUrl}/customers?page=${page}&limit=${resultsPerPage}&search=${searchTerm}`);
      const data = await response.json();
      renderCustomerTable(data.customers);
      renderCustomerPagination(data.totalPages, page);
    }
  
    // Fetch and render invoice data
    async function fetchInvoices(page = 1, searchTerm = '') {
      const response = await fetch(`${apiUrl}/invoices?page=${page}&limit=${resultsPerPage}&search=${searchTerm}`);
      const data = await response.json();
      renderInvoiceTable(data.invoices);
      renderInvoicePagination(data.totalPages, page);
    }
  
    // Render customer table
    function renderCustomerTable(customers) {
      const tableBody = document.getElementById('customerTableBody');
      tableBody.innerHTML = '';
      customers.forEach(customer => {
        const row = `<tr>
          <td>${customer.name}</td>
          <td>${customer.address}</td>
          <td>${customer.stateCode}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer._id}')">Delete</button></td>
        </tr>`;
        tableBody.innerHTML += row;
      });
    }
  
    // Render invoice table
    function renderInvoiceTable(invoices) {
      const tableBody = document.getElementById('invoiceTableBody');
      tableBody.innerHTML = '';
      invoices.forEach(invoice => {
        const row = `<tr>
          <td>${new Date(invoice.date).toLocaleDateString()}</td>
          <td>${invoice.invoiceNo}</td>
          <td>${invoice.gstin}</td>
          <td>${invoice.taxRate}%</td>
          <td>${invoice.totalValue}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice._id}')">Delete</button></td>
        </tr>`;
        tableBody.innerHTML += row;
      });
    }
  
    // Render customer pagination
    function renderCustomerPagination(totalPages, currentPage) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changeCustomerPage(${i})">${i}</a>
        </li>`;
      }
    }
  
    // Render invoice pagination
    function renderInvoicePagination(totalPages, currentPage) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changeInvoicePage(${i})">${i}</a>
        </li>`;
      }
    }
  
    // Handle customer page change
    function changeCustomerPage(page) {
      currentCustomerPage = page;
      fetchCustomers(page, document.getElementById('searchInput').value);
    }
  
    // Handle invoice page change
    function changeInvoicePage(page) {
      currentInvoicePage = page;
      fetchInvoices(page, document.getElementById('searchInput').value);
    }
  
    // Search functionality
    function searchTable() {
      const searchTerm = document.getElementById('searchInput').value;
      fetchCustomers(currentCustomerPage, searchTerm);
      fetchInvoices(currentInvoicePage, searchTerm);
    }
  
    document.getElementById('searchInput').addEventListener('input', searchTable);
  
    // Handle customer form submission
    document.getElementById('customerForm').onsubmit = async function(event) {
      event.preventDefault();
      const name = document.getElementById('name').value;
      const address = document.getElementById('address').value;
      const stateCode = document.getElementById('stateCode').value;
  
      const response = await fetch(`${apiUrl}/customers`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, address, stateCode })
      });
  
      if (response.ok) {
        alert('Customer added successfully!');
        fetchCustomers(currentCustomerPage);
        document.getElementById('customerForm').reset();
      } else {
        alert('Failed to add customer.');
      }
    };
  
    // Handle invoice form submission
    document.getElementById('invoiceForm').onsubmit = async function(event) {
      event.preventDefault();
      const invoiceNo = document.getElementById('invoiceNo').value;
      const gstin = document.getElementById('gstin').value;
      const taxRate = document.getElementById('taxRate').value;
      const taxableValue = document.getElementById('taxableValue').value;
      const cgst = document.getElementById('cgst').value;
      const sgst = document.getElementById('sgst').value;
      const igst = document.getElementById('igst').value;
      const totalValue = document.getElementById('totalValue').value;
  
      const response = await fetch(`${apiUrl}/invoices`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          invoiceNo, gstin, taxRate, taxableValue, cgst, sgst, igst, totalValue
        })
      });
  
      if (response.ok) {
        alert('Invoice added successfully!');
        fetchInvoices(currentInvoicePage);
        document.getElementById('invoiceForm').reset();
      } else {
        alert('Failed to add invoice.');
      }
    };
  
    // Delete customer
    async function deleteCustomer(id) {
      if (confirm('Are you sure you want to delete this customer?')) {
        const response = await fetch(`${apiUrl}/customers/${id}`, {
          method: 'DELETE'
        });
  
        if (response.ok) {
          alert('Customer deleted successfully!');
          fetchCustomers(currentCustomerPage);
        } else {
          alert('Failed to delete customer.');
        }
      }
    }
  
    // Delete invoice
    async function deleteInvoice(id) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        const response = await fetch(`${apiUrl}/invoices/${id}`, {
          method: 'DELETE'
        });
  
        if (response.ok) {
          alert('Invoice deleted successfully!');
          fetchInvoices(currentInvoicePage);
        } else {
          alert('Failed to delete invoice.');
        }
      }
    }
  
    // Fetch initial data on page load
    window.onload = function() {
      fetchCustomers();
      fetchInvoices();
    };
  </script>
  
</body>
</html>
